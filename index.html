<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chiến sĩ số thông minh - Toán Lớp 1</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #e0f7fa;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Nunito', sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }

        #gameContainer {
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border-radius: 15px;
            overflow: hidden;
            background: #fff;
        }

        canvas {
            display: block;
            touch-action: none;
        }

        /* Overlay trung (Start Screen + Game Over Screen) */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            color: white;
            text-align: center;
        }

        button {
            padding: 15px 30px;
            font-size: 24px;
            font-family: 'Nunito', sans-serif;
            font-weight: 900;
            background: #FFD700;
            color: #d32f2f;
            border: 4px solid #fff;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 0 #b29700;
            margin-top: 20px;
        }

        button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 0 #b29700;
        }

        h1 {
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 #333;
            color: #76ff03;
        }
    </style>
</head>
<body>

    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <!-- Màn hình bắt đầu -->
        <div id="startScreen" class="overlay">
            <h1>CHIẾN SĨ SỐ THÔNG MINH</h1>
            <p style="margin-bottom: 30px; font-size: 18px;">Các chiến sĩ nhí hãy nhớ luân phiên vượt qua các thử thách nhé</p>
            <button id="btnStart">BẮT ĐẦU CHƠI</button>
        </div>

        <!-- Màn hình kết thúc (Mới) -->
        <div id="gameOverScreen" class="overlay" style="display: none;">
            <h1 style="color: #FFD700;">HOÀN THÀNH NHIỆM VỤ!</h1>
            <p id="finalScore" style="font-size: 24px;">Điểm số: 0/0</p>
            <button id="btnReplay">CHƠI LẠI</button>
        </div>
    </div>

<script>
/**
 * CẤU HÌNH GAME & DỮ LIỆU
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const startScreen = document.getElementById('startScreen');
const gameOverScreen = document.getElementById('gameOverScreen');
const btnStart = document.getElementById('btnStart');
const btnReplay = document.getElementById('btnReplay');
const finalScoreText = document.getElementById('finalScore');

const questionsData = [
    { q: "8 + 0", a: 8 },
    { q: "10 - 5", a: 5 },
    { q: "0 + 7", a: 7 },
    { q: "6 - 1", a: 5 }
];

let gameState = {
    currentQuestionIndex: 0,
    score: 0,
    options: [],
    isPlaying: false,
    feedbackTimer: 0,
    feedbackType: null, // 'correct' | 'wrong' | null
    mouse: { x: 0, y: 0, isDown: false },
    sparkles: [] // Mảng chứa hiệu ứng lấp lánh
};

/**
 * PHẦN 1: HỆ THỐNG ÂM THANH
 */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let isMusicOn = true;

function playTone(freq, type, duration, startTime = 0) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime + startTime);
    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime + startTime);
    gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + startTime + duration);
    osc.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    osc.start(audioCtx.currentTime + startTime);
    osc.stop(audioCtx.currentTime + startTime + duration);
}

function playCorrectSound() {
    playTone(1318.51, 'triangle', 0.1, 0);      // E6
    playTone(1567.98, 'sine', 0.3, 0.1);    // G6
}

function playWrongSound() {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(150, audioCtx.currentTime);
    osc.frequency.linearRampToValueAtTime(80, audioCtx.currentTime + 0.4);
    gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
    gainNode.gain.linearRampToValueAtTime(0.001, audioCtx.currentTime + 0.4);
    osc.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.4);
}

// Cập nhật link nhạc nền mới
const bgMusic = new Audio('https://aeiouly.s3.ap-southeast-1.amazonaws.com/sounds/nhacnen2.mp3');
bgMusic.loop = true;
bgMusic.volume = 0.4;

function startBackgroundMusic() {
    if (!isMusicOn) return;
    bgMusic.play().catch(e => console.log("Lỗi phát nhạc:", e));
}

function stopBackgroundMusic() {
    bgMusic.pause();
}

/**
 * PHẦN 2: HỆ THỐNG ĐỒ HỌA
 */

function drawStar(ctx, cx, cy, spikes, outerRadius, innerRadius, color) {
    let rot = Math.PI / 2 * 3;
    let x = cx;
    let y = cy;
    let step = Math.PI / spikes;
    ctx.beginPath();
    ctx.moveTo(cx, cy - outerRadius);
    for (let i = 0; i < spikes; i++) {
        x = cx + Math.cos(rot) * outerRadius;
        y = cy + Math.sin(rot) * outerRadius;
        ctx.lineTo(x, y);
        rot += step;
        x = cx + Math.cos(rot) * innerRadius;
        y = cy + Math.sin(rot) * innerRadius;
        ctx.lineTo(x, y);
        rot += step;
    }
    ctx.lineTo(cx, cy - outerRadius);
    ctx.closePath();
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#c62828'; // Viền cho sao vàng nếu cần
    if (color === '#FFFF00' || color === '#FFEB3B') ctx.strokeStyle = 'rgba(255,0,0,0.3)';
    ctx.stroke();
    ctx.fillStyle = color;
    ctx.fill();
}

// Hàm vẽ cờ đỏ sao vàng
function drawFlag(x, y) {
    // Cột cờ
    ctx.fillStyle = '#C0C0C0';
    ctx.fillRect(x, y, 10, 300);
    // Bóng cột
    ctx.fillStyle = '#A0A0A0';
    ctx.fillRect(x+8, y, 2, 300);

    // Đế cột cờ
    ctx.fillStyle = '#795548';
    ctx.fillRect(x - 20, y + 290, 50, 10);

    // Lá cờ (Có hiệu ứng lượn sóng đơn giản)
    ctx.fillStyle = '#D50000'; // Đỏ cờ
    ctx.beginPath();
    ctx.moveTo(x + 10, y + 10);
    ctx.quadraticCurveTo(x + 60, y + 20, x + 110, y + 10); // Cạnh trên
    ctx.lineTo(x + 110, y + 80);
    ctx.quadraticCurveTo(x + 60, y + 90, x + 10, y + 80); // Cạnh dưới
    ctx.closePath();
    ctx.fill();

    // Sao vàng trên cờ
    drawStar(ctx, x + 60, y + 45, 5, 15, 6, '#FFFF00');
}

// Hàm vẽ bong bóng chat dễ thương
function drawCuteSpeechBubble(x, y, text) {
    ctx.save();
    ctx.translate(x, y);

    // Bong bóng tròn trĩnh (Ellipse)
    ctx.beginPath();
    ctx.ellipse(0, 0, 110, 45, 0, 0, 2 * Math.PI);
    ctx.fillStyle = '#fff';
    ctx.fill();
    ctx.lineWidth = 3;
    ctx.strokeStyle = '#333';
    ctx.stroke();

    // Đuôi bong bóng (Điều chỉnh hướng xuống dưới bên trái một chút để trỏ vào nhân vật ở dưới)
    ctx.beginPath();
    ctx.moveTo(-20, 40); // Điểm bắt đầu bên trái dưới
    ctx.quadraticCurveTo(-40, 70, -10, 90); // Đỉnh đuôi trỏ xuống
    ctx.quadraticCurveTo(10, 50, 40, 40); // Điểm kết thúc
    ctx.fillStyle = '#fff';
    ctx.fill();
    ctx.stroke();
    
    // Che nét cắt giữa đuôi và bóng
    ctx.beginPath();
    ctx.moveTo(-30, 35);
    ctx.lineTo(50, 35);
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 5;
    ctx.stroke();

    // Text
    ctx.fillStyle = '#000';
    ctx.font = 'bold 16px Nunito';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(text, 0, 0);
    
    ctx.restore();
}

// Hàm vẽ bộ đội nhí chi tiết (Full body) - Đã thêm tham số isFemale
function drawDetailedSoldier(x, y, isSaluting = false, isFemale = false) {
    ctx.save();
    ctx.translate(x, y);

    // --- HÀM VẼ BÍM TÓC (Helper) ---
    const drawBraid = (bx, by, rot) => {
        ctx.save();
        ctx.translate(bx, by);
        ctx.rotate(rot);
        
        ctx.fillStyle = '#212121';
        // Vẽ các đốt tóc tết
        for(let i = 0; i < 3; i++) {
            ctx.beginPath();
            ctx.ellipse(0, i * 9 + 5, 8, 9, 0, 0, Math.PI*2);
            ctx.fill();
        }
        
        // Đuôi tóc
        ctx.beginPath();
        ctx.moveTo(-5, 28);
        ctx.quadraticCurveTo(0, 45, 5, 28);
        ctx.fill();

        // Dây chun đỏ
        ctx.fillStyle = '#D32F2F';
        ctx.beginPath();
        ctx.rect(-6, -2, 12, 5); 
        ctx.fill();
        
        ctx.restore();
    };

    // 0. VẼ TÓC SAU LƯNG (Nếu là nữ - Vẽ trước thân mình để tạo hiệu ứng sau lưng)
    if (isFemale) {
        // Bím trái (hơi nghiêng ra)
        drawBraid(-25, 0, 0.1);
        // Bím phải (hơi nghiêng ra)
        drawBraid(25, 0, -0.1);
    }

    // 1. Chân (Quần xanh)
    ctx.fillStyle = '#33691E'; 
    // Chân trái
    ctx.fillRect(-25, 60, 20, 50);
    // Chân phải
    ctx.fillRect(5, 60, 20, 50);

    // 2. Giày (Màu đen)
    ctx.fillStyle = '#212121';
    ctx.beginPath();
    ctx.ellipse(-15, 110, 12, 6, 0, 0, Math.PI * 2); // Giày trái
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(15, 110, 12, 6, 0, 0, Math.PI * 2); // Giày phải
    ctx.fill();

    // 3. Thân (Áo xanh bộ đội)
    ctx.fillStyle = '#558B2F'; // Xanh lá cây
    ctx.beginPath();
    ctx.roundRect(-35, 0, 70, 70, 10); // Áo bo tròn góc
    ctx.fill();
    
    // Thắt lưng
    ctx.fillStyle = '#3E2723';
    ctx.fillRect(-35, 45, 70, 8);
    // Mặt thắt lưng vàng
    ctx.fillStyle = '#FFD700';
    ctx.fillRect(-5, 45, 10, 8);

    // Túi áo
    ctx.strokeStyle = '#33691E';
    ctx.lineWidth = 1;
    ctx.strokeRect(-25, 10, 20, 20);
    ctx.strokeRect(5, 10, 20, 20);

    // 4. Đầu
    ctx.fillStyle = '#FFCCBC'; // Màu da
    ctx.beginPath();
    ctx.arc(0, -20, 35, 0, Math.PI * 2);
    ctx.fill();

    // --- VẼ PHẦN TÓC MÁI/BÚI NỮ (Để che phần nối với bím tóc sau lưng) ---
    if (isFemale) {
        ctx.fillStyle = '#212121'; // Tóc đen
        // Vẽ phần tóc ôm nhẹ 2 bên tai cho gọn gàng
        ctx.beginPath(); ctx.ellipse(-30, -22, 10, 15, -0.2, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(30, -22, 10, 15, 0.2, 0, Math.PI*2); ctx.fill();
    }
    // ----------------------------

    // 5. Tay
    ctx.fillStyle = '#558B2F'; // Màu áo tay
    
    if (isSaluting) {
        // Tay phải chào
        ctx.beginPath();
        ctx.moveTo(35, 10);
        ctx.lineTo(55, -20); // Cánh tay dưới lên
        ctx.strokeStyle = '#558B2F';
        ctx.lineWidth = 14;
        ctx.lineCap = 'round';
        ctx.stroke();
        
        // Bàn tay chào
        ctx.fillStyle = '#FFCCBC';
        ctx.beginPath();
        ctx.ellipse(58, -25, 6, 12, Math.PI/4, 0, Math.PI*2);
        ctx.fill();

        // Tay trái buông xuôi
        ctx.beginPath();
        ctx.moveTo(-35, 10);
        ctx.lineTo(-35, 50);
        ctx.stroke();
        // Bàn tay trái
        ctx.fillStyle = '#FFCCBC';
        ctx.beginPath();
        ctx.arc(-35, 55, 6, 0, Math.PI*2);
        ctx.fill();

    } else {
        // Hai tay buông xuôi hoặc nắm hờ
        ctx.lineWidth = 14;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#558B2F';
        
        // Tay trái
        ctx.beginPath(); ctx.moveTo(-35, 10); ctx.lineTo(-40, 45); ctx.stroke();
        // Tay phải
        ctx.beginPath(); ctx.moveTo(35, 10); ctx.lineTo(40, 45); ctx.stroke();
        
        // Bàn tay
        ctx.fillStyle = '#FFCCBC';
        ctx.beginPath(); ctx.arc(-40, 50, 6, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(40, 50, 6, 0, Math.PI*2); ctx.fill();
    }

    // 6. Khuôn mặt (Biểu cảm)
    ctx.fillStyle = '#333';
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 2;

    if (gameState.feedbackType === 'wrong') {
        // Mắt buồn
        ctx.beginPath(); ctx.moveTo(-15, -20); ctx.lineTo(-5, -20); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(5, -20); ctx.lineTo(15, -20); ctx.stroke();
        // Mếu
        ctx.beginPath(); ctx.arc(0, -5, 8, Math.PI, 0, false); ctx.stroke();
    } else if (gameState.feedbackType === 'correct') {
        // Mắt cười
        ctx.beginPath(); ctx.arc(-10, -20, 5, Math.PI, 0); ctx.stroke();
        ctx.beginPath(); ctx.arc(10, -20, 5, Math.PI, 0); ctx.stroke();
        // Cười
        ctx.beginPath(); ctx.arc(0, -10, 10, 0, Math.PI, false); ctx.stroke();
    } else {
        // Bình thường
        ctx.beginPath(); ctx.arc(-10, -20, 3, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(10, -20, 3, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(0, -10, 6, 0, Math.PI, false); ctx.stroke();
    }
    // Má hồng
    ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';
    ctx.beginPath(); ctx.arc(-18, -12, 5, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(18, -12, 5, 0, Math.PI*2); ctx.fill();

    // 7. Mũ cối
    ctx.save();
    ctx.translate(0, -45); // Dịch lên đỉnh đầu
    ctx.beginPath();
    ctx.arc(0, 0, 38, Math.PI, 0); // Vòm mũ
    ctx.fillStyle = '#2E7D32';
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(0, 0, 48, 10, 0, 0, 2 * Math.PI); // Vành mũ
    ctx.fillStyle = '#2E7D32';
    ctx.fill();
    // Sao trên mũ
    drawStar(ctx, 0, -20, 5, 6, 2.5, '#FFFF00');
    ctx.restore();

    ctx.restore();
}

function drawPithHelmet(x, y, scale, number, isHovered, isCorrectHighlight = false) {
    ctx.save();
    ctx.translate(x, y);
    ctx.scale(scale, scale);
    if (isHovered) ctx.scale(1.1, 1.1);

    // Hiệu ứng Highlight (cho đáp án đúng khi user chọn sai)
    if (isCorrectHighlight) {
        ctx.shadowColor = "#76FF03";
        ctx.shadowBlur = 20;
    }

    // Chóp mũ
    ctx.beginPath();
    ctx.arc(0, 0, 60, Math.PI, 0);
    ctx.fillStyle = '#2E7D32';
    ctx.fill();
    ctx.lineWidth = 3;
    ctx.strokeStyle = '#1B5E20';
    ctx.stroke();

    // Vành mũ
    ctx.beginPath();
    ctx.ellipse(0, 0, 80, 20, 0, 0, 2 * Math.PI);
    ctx.fillStyle = '#388E3C';
    ctx.fill();
    ctx.stroke();

    // Sao vàng
    drawStar(ctx, 0, -25, 5, 12, 5, '#FFEB3B');

    // Số
    ctx.beginPath();
    ctx.arc(0, -70, 25, 0, Math.PI * 2);
    ctx.fillStyle = '#fff';
    ctx.fill();
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.fillStyle = '#d32f2f';
    ctx.font = 'bold 30px Nunito';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(number, 0, -68);

    ctx.restore();
}

function updateSparkles() {
    if (Math.random() < 0.1) {
        gameState.sparkles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * 400,
            size: Math.random() * 5 + 2,
            opacity: 0,
            life: 0,
            maxLife: 50 + Math.random() * 50
        });
    }
    for (let i = gameState.sparkles.length - 1; i >= 0; i--) {
        let s = gameState.sparkles[i];
        s.life++;
        if (s.life < 20) s.opacity = s.life / 20;
        else if (s.life > s.maxLife - 20) s.opacity = (s.maxLife - s.life) / 20;
        else s.opacity = 1;
        if (s.life >= s.maxLife) gameState.sparkles.splice(i, 1);
    }
}

function drawSparkles() {
    ctx.fillStyle = '#FFFDE7';
    for (let s of gameState.sparkles) {
        ctx.globalAlpha = s.opacity;
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.lineWidth = 1;
        ctx.strokeStyle = "rgba(255, 255, 255, 0.8)";
        ctx.beginPath();
        ctx.moveTo(s.x - s.size * 1.5, s.y);
        ctx.lineTo(s.x + s.size * 1.5, s.y);
        ctx.moveTo(s.x, s.y - s.size * 1.5);
        ctx.lineTo(s.x, s.y + s.size * 1.5);
        ctx.stroke();
    }
    ctx.globalAlpha = 1;
}

function drawTable() {
    const tableY = 480;
    ctx.fillStyle = '#8D6E63'; 
    ctx.beginPath();
    ctx.moveTo(0, tableY);
    ctx.lineTo(canvas.width, tableY);
    ctx.lineTo(canvas.width, tableY + 30);
    ctx.lineTo(0, tableY + 30);
    ctx.fill();
    ctx.strokeStyle = '#5D4037';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(0, tableY + 28);
    ctx.lineTo(canvas.width, tableY + 28);
    ctx.stroke();
    ctx.fillStyle = '#795548'; 
    ctx.fillRect(50, tableY + 30, canvas.width - 100, canvas.height - (tableY + 30));
    ctx.fillStyle = 'rgba(0,0,0,0.2)';
    ctx.fillRect(50, tableY + 30, canvas.width - 100, 10);
}

function drawBackground() {
    const gradient = ctx.createLinearGradient(0, 0, 0, 600);
    gradient.addColorStop(0, '#29B6F6'); 
    gradient.addColorStop(0.5, '#B3E5FC');
    gradient.addColorStop(0.5, '#7CB342');
    gradient.addColorStop(1, '#558B2F'); 
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    drawSparkles();
    ctx.fillStyle = '#4CAF50'; 
    ctx.beginPath(); ctx.moveTo(0, 300); ctx.lineTo(150, 150); ctx.lineTo(350, 300); ctx.fill();
    ctx.fillStyle = '#388E3C'; 
    ctx.beginPath(); ctx.moveTo(250, 300); ctx.lineTo(500, 100); ctx.lineTo(750, 300); ctx.fill();
    ctx.fillStyle = '#689F38';
    ctx.fillRect(0, 300, canvas.width, 300); 
    ctx.fillStyle = '#33691E';
    for(let i=0; i<canvas.width; i+=40) {
        let h = Math.random() * 20 + 10;
        ctx.beginPath(); ctx.moveTo(i, 300); ctx.lineTo(i+10, 300-h); ctx.lineTo(i+20, 300); ctx.fill();
    }
    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
    ctx.beginPath(); ctx.arc(100, 50, 30, 0, Math.PI*2); ctx.arc(140, 50, 40, 0, Math.PI*2); ctx.arc(180, 50, 30, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(600, 80, 25, 0, Math.PI*2); ctx.arc(640, 80, 35, 0, Math.PI*2); ctx.arc(680, 80, 25, 0, Math.PI*2); ctx.fill();
    drawFlag(80, 180); 
}

function drawBoard(questionText, questionIndex) {
    const bx = 250, by = 100, bw = 300, bh = 150; 
    ctx.strokeStyle = '#5D4037'; ctx.lineWidth = 8;
    ctx.beginPath(); 
    ctx.moveTo(bx + 50, by + bh); ctx.lineTo(bx + 30, by + bh + 250); 
    ctx.moveTo(bx + bw - 50, by + bh); ctx.lineTo(bx + bw - 30, by + bh + 250); 
    ctx.stroke();
    ctx.fillStyle = '#263238'; 
    ctx.fillRect(bx, by, bw, bh);
    ctx.lineWidth = 10; ctx.strokeStyle = '#8D6E63'; ctx.strokeRect(bx, by, bw, bh);
    ctx.fillStyle = '#FFD54F'; 
    ctx.font = 'bold 20px Nunito';
    ctx.textAlign = 'center';
    ctx.fillText("Câu " + (questionIndex + 1), bx + bw/2, by + 30);
    ctx.fillStyle = '#fff'; 
    ctx.font = 'bold 50px Nunito'; 
    ctx.textBaseline = 'middle';
    ctx.fillText(questionText + " = ?", bx + bw/2, by + bh/2 + 10);
}

/**
 * PHẦN 3: LOGIC GAME
 */

function generateOptions(correctAnswer) {
    let opts = [correctAnswer];
    while (opts.length < 3) {
        let val = Math.floor(Math.random() * 11); 
        if (!opts.includes(val)) opts.push(val);
    }
    return opts.sort(() => Math.random() - 0.5);
}

function setupLevel() {
    if (gameState.currentQuestionIndex >= questionsData.length) {
        endGame();
        return;
    }

    gameState.feedbackType = null;
    const qData = questionsData[gameState.currentQuestionIndex];
    const rawOptions = generateOptions(qData.a);
    
    gameState.options = [];
    const spacing = 200;
    const startX = (canvas.width - spacing * 2) / 2;

    rawOptions.forEach((val, index) => {
        gameState.options.push({
            value: val,
            x: startX + index * spacing,
            y: 470, 
            radius: 70,
            isCorrect: val === qData.a
        });
    });
}

function update() {
    updateSparkles();
    if (gameState.feedbackTimer > 0) {
        gameState.feedbackTimer--;
    } else if (gameState.feedbackTimer === 0 && gameState.feedbackType) {
         if(gameState.feedbackType === 'wrong') gameState.feedbackType = null;
    }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    drawBackground();

    if (!gameState.isPlaying) {
        drawDetailedSoldier(150, 350, true, false); // Nam
        drawDetailedSoldier(650, 350, false, false); // Nữ -> Nam
        return; 
    }

    drawBoard(questionsData[gameState.currentQuestionIndex].q, gameState.currentQuestionIndex);
    drawTable();

    // Vẽ 2 chú bộ đội đứng 2 bên bảng (sau bàn)
    drawDetailedSoldier(150, 320, true, false); // Chú bên trái (Nam)
    drawDetailedSoldier(650, 320, false, false); // Chú bên phải (Nữ -> Nam)

    // Bong bóng chat CHỈ hiển thị ở câu số 3 (index = 2, tức là sau khi kết thúc câu 2)
    if (gameState.currentQuestionIndex === 2) {
        // Vị trí mới không che bảng (bảng kết thúc x=550), đưa lên cao và lệch phải
        drawCuteSpeechBubble(670, 180, "Đến lượt bạn còn lại!");
    }

    // Vẽ mũ đáp án
    gameState.options.forEach(opt => {
        const dx = gameState.mouse.x - opt.x;
        const dy = gameState.mouse.y - opt.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        const isHovered = dist < opt.radius;
        
        let isCorrectHighlight = false;
        if (gameState.feedbackTimer > 0 && gameState.feedbackType === 'wrong' && opt.isCorrect) {
            isCorrectHighlight = true;
        }

        drawPithHelmet(opt.x, opt.y, 0.9, opt.value, isHovered, isCorrectHighlight);
        
        if (isCorrectHighlight) {
            ctx.save();
            ctx.fillStyle = '#76FF03';
            ctx.font = 'bold 20px Nunito';
            ctx.textAlign = 'center';
            ctx.shadowColor = 'black';
            ctx.shadowBlur = 4;
            ctx.fillText("Đúng đây nè!", opt.x, opt.y - 100);
            ctx.restore();
        }
    });

    if (gameState.feedbackTimer > 0) {
        ctx.font = 'bold 80px Nunito';
        ctx.textAlign = 'center';
        ctx.save();
        ctx.shadowColor = "rgba(0,0,0,0.5)";
        ctx.shadowBlur = 10;
        if (gameState.feedbackType === 'correct') {
            ctx.fillStyle = '#76FF03';
            ctx.fillText("ĐÚNG RỒI!", canvas.width/2, 250);
        } else {
            ctx.fillStyle = '#FF1744';
            ctx.fillText("CHƯA ĐÚNG!", canvas.width/2, 250);
        }
        ctx.restore();
    }

    // Vẽ điểm nổi bật
    ctx.save();
    ctx.font = '900 30px Nunito';
    ctx.textAlign = 'left';
    ctx.lineWidth = 4;
    ctx.strokeStyle = '#E65100'; 
    ctx.strokeText("Điểm: " + gameState.score, 20, 50);
    ctx.fillStyle = '#FFEB3B'; 
    ctx.fillText("Điểm: " + gameState.score, 20, 50);
    ctx.restore();
}

function gameLoop() {
    update();
    draw();
    if (gameState.isPlaying) {
        requestAnimationFrame(gameLoop);
    }
}

// Mouse Events
function getMousePos(evt) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    return {
        x: (evt.clientX - rect.left) * scaleX,
        y: (evt.clientY - rect.top) * scaleY
    };
}

canvas.addEventListener('mousemove', (e) => {
    const pos = getMousePos(e);
    gameState.mouse.x = pos.x;
    gameState.mouse.y = pos.y;
});

canvas.addEventListener('click', (e) => {
    if (!gameState.isPlaying || gameState.feedbackTimer > 0) return;

    const pos = getMousePos(e);
    for (let opt of gameState.options) {
        const dx = pos.x - opt.x;
        const dy = pos.y - opt.y;
        if (Math.sqrt(dx*dx + dy*dy) < 60) {
            checkAnswer(opt);
            break;
        }
    }
});

function checkAnswer(selectedOption) {
    if (selectedOption.isCorrect) {
        gameState.score++;
        gameState.feedbackType = 'correct';
        playCorrectSound();
    } else {
        gameState.feedbackType = 'wrong';
        playWrongSound();
    }

    gameState.feedbackTimer = 90; // Tăng thời gian chờ lên 1.5s để bé kịp nhìn đáp án đúng
    setTimeout(() => {
        gameState.currentQuestionIndex++;
        setupLevel();
    }, 1500);
}

function startGame() {
    startScreen.style.display = 'none';
    gameOverScreen.style.display = 'none';
    gameState.isPlaying = true;
    gameState.score = 0;
    gameState.currentQuestionIndex = 0;
    
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
    
    setupLevel();
    startBackgroundMusic();
    gameLoop();
}

function endGame() {
    gameState.isPlaying = false;
    stopBackgroundMusic();
    draw(); 

    // Hiện màn hình Game Over
    finalScoreText.innerText = "Điểm của các chiến sĩ nhí: " + gameState.score + "/" + questionsData.length;
    gameOverScreen.style.display = 'flex';
}

// Bắt sự kiện nút
btnStart.addEventListener('click', startGame);
btnReplay.addEventListener('click', startGame);

// Vẽ nền khởi đầu (preview)
drawBackground();
drawDetailedSoldier(150, 350, true, false); // Nam
drawDetailedSoldier(650, 350, false, false); // Nữ -> Nam

</script>
</body>
</html>